# DropRateSetting Mod 文档

## 简介

DropRateSetting 是一个用于修改游戏掉落率的Mod。通过这个Mod，玩家可以调整敌人掉落物品的概率和数量。

## 功能特性

1. 可调节的爆率倍数（控制高品质物品掉落概率）
2. 可调节的爆出个数倍数（控制战利品箱物品数量）
3. 启用/禁用开关（防止与其他修改掉率的Mod冲突）
4. 通过ModConfig界面进行实时配置
5. 配置自动保存和加载
6. 智能重新生成机制（只刷新未打开的战利品箱）
7. 场景切换安全机制（避免在基地场景刷新物品）
8. 异步操作管理（确保操作的原子性和安全性）

## 配置说明

### 爆率 (Spawn Chance)
- 控制高品质物品掉落概率
- 范围: 1 - 200 (默认值: 1)
- 类型: 整数
- 倍数越高，高品质物品掉落概率越大

### 爆出个数 (Random Count)
- 控制战利品箱物品数量
- 范围: 1 - 5 (默认值: 1)
- 类型: 整数
- 倍数越高，战利品箱物品数量越多

### 启用/禁用开关
- 控制Mod功能是否生效
- 默认值: 关闭
- 类型: 布尔值
- 关闭时恢复游戏默认掉率设置，防止与其他修改掉率的Mod冲突

## 使用方法

1. 安装Mod后启动游戏
2. 在主菜单中找到"Mod设置"选项
3. 在设置界面中找到"DropRateSetting"配置项
4. 首先启用"是否启用本mod"开关
5. 调整"爆率"和"爆出个数"滑块到所需值
6. 设置会自动保存并在游戏中实时生效

## 技术实现

### 核心组件

1. **ModConfigDropRateManager.cs** - 负责配置管理
   - 与ModConfig系统集成
   - 管理配置项的加载和保存
   - 提供配置值给其他组件使用
   - 实现配置持久化功能

2. **LootSpawnerPatch.cs** - 负责重新生成战利品
   - 使用Harmony库进行代码补丁
   - 实现重新生成战利品的功能，确保设置更改后能立即看到效果
   - 智能处理已打开的战利品箱，避免重复生成
   - 安全地清理和重新生成箱子内容，避免物资溢出
   - 实现场景切换检测，避免在基地场景刷新物品
   - 管理异步操作状态，确保操作的原子性和安全性

3. **ModBehaviour.cs** - Mod主入口
   - 初始化Harmony补丁
   - 创建配置管理器实例
   - 管理Mod的生命周期
   - 通过反射修改LevelConfig属性值
   - 实时监控配置变更并应用
   - 实现场景切换检测，确保操作安全性

4. **ModConfigApi.cs** - ModConfig接口封装
   - 提供安全的ModConfig API调用
   - 处理ModConfig不可用的情况
   - 封装配置项的添加和读取方法

5. **HarmonyLoad.cs** - Harmony库加载器
   - 负责在运行时加载嵌入的Harmony库
   - 避免部署时的依赖问题

### 工作原理

1. Mod启动时初始化配置管理器和Harmony补丁
2. 配置管理器从本地文件加载持久化配置，然后注册两个滑块配置项：爆率和爆出个数，以及一个启用/禁用开关
3. 当玩家调整配置时，配置管理器会更新内部值并通知其他组件
4. ModBehaviour通过反射直接修改LevelConfig的lootBoxHighQualityChanceMultiplier和LootboxItemCountMultiplier字段值
5. 当配置更改时，会触发重新生成未打开的战利品箱
6. LootSpawnerPatch负责安全地重新生成箱子内容：
   - 检查箱子是否已被打开，避免重复生成
   - 检查是否在基地场景，避免在基地刷新物品
   - 安全地清理箱子内容，避免物资溢出
   - 使用LootBoxLoader重新生成物品，确保爆率设置生效
   - 实现场景切换检测，确保操作安全性
7. 所有配置变更都会自动保存到本地JSON文件中，确保重启游戏后设置保持不变

## 故障排除

### 配置不生效
1. 确认ModConfig系统正常工作
2. 检查日志文件查看是否有错误信息
3. 确认配置值是否正确加载

### 掉落率没有变化
1. 确认敌人类型是否支持掉落物品
2. 检查游戏原生的掉落逻辑是否被其他Mod影响
3. 查看日志确认补丁是否正确应用

### 物品溢出到地图上
1. 检查是否正确清理了箱子内容
2. 确认是否正确使用了LootBoxLoader重新生成物品
3. 查看日志确认重新生成过程是否正常

### 回到基地时崩溃
1. 确认是否正确实现了场景切换检测
2. 检查是否在场景切换时正确中断了异步操作
3. 查看日志确认崩溃时的操作状态

## 版本历史

### v1.0.0
- 初始版本
- 添加爆率和爆出个数配置项
- 实现基本的掉落率修改功能

### v1.1.0
- 优化配置更新逻辑
- 改进日志记录
- 修复数值类型问题

### v1.2.0
- 修改目标属性，使用真正影响爆率的LevelConfig属性
- lootBoxHighQualityChanceMultiplier 对应爆率设置
- LootboxItemCountMultiplier 对应爆出个数设置

### v1.3.0
- 添加启用/禁用开关，防止与其他修改掉率的Mod冲突
- 实现配置持久化，重启游戏后设置保持不变
- 智能重新生成机制，只刷新未打开的战利品箱

### v1.4.0
- 添加配置界面实时更新功能
- 优化配置变更检测逻辑
- 添加即时刷新按钮，允许玩家手动触发战利品箱重新生成

### v1.5.0
- 实现场景切换安全机制，避免在基地场景刷新物品
- 实现异步操作管理，确保操作的原子性和安全性
- 优化箱子内容清理和重新生成逻辑，避免物资溢出
- 添加延迟刷新机制，提高性能和稳定性

## 已知问题

1. 在某些情况下，配置更新可能不会立即反映在已经生成的敌人上
2. 与其他修改掉落逻辑的Mod可能存在兼容性问题
3. 配置界面可能需要重新打开才能看到最新的设置值

## 技术支持

如遇到问题，请查看日志文件或联系开发者。
日志文件位置: `<游戏目录>/DropRateSetting.log`